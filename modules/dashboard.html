<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>JARVIS Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

  :root {
    --accent:  #00d4ff;
    --accent2: #00ff9d;
    --warn:    #ff6b35;
    --crit:    #ff3366;
    --bg:      #020d1a;
    --glass:   rgba(0, 180, 255, 0.05);
    --border:  rgba(0, 212, 255, 0.15);
    --text:    rgba(200, 240, 255, 0.9);
    --dim:     rgba(200, 240, 255, 0.4);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    font-family: 'Share Tech Mono', monospace;
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    position: relative;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Animated bg gradients */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 20%, rgba(0,100,200,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(0,200,150,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 40% 30% at 50% 50%, rgba(0,50,100,0.15) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* Grid lines */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    display: grid;
    grid-template-rows: 56px 1fr;
    grid-template-columns: 270px 1fr 210px;
    gap: 10px;
    padding: 10px;
    height: 100vh;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 18px;
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 10px;
    backdrop-filter: blur(20px);
    position: relative;
    overflow: hidden;
    cursor: move;
  }

  header::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scanline 3s linear infinite;
  }

  @keyframes scanline {
    0%   { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 20px;
    letter-spacing: 6px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,212,255,0.6), 0 0 40px rgba(0,212,255,0.3);
  }
  .logo span { color: var(--accent2); }

  .hdr-mid {
    display: flex;
    align-items: center;
    gap: 18px;
    font-size: 11px;
    color: var(--dim);
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent2);
    box-shadow: 0 0 8px var(--accent2);
    animation: pulse 2s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes pulse {
    0%,100% { opacity:1; transform:scale(1); }
    50%      { opacity:0.5; transform:scale(0.8); }
  }

  #state-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--accent2);
  }

  .mini-bars {
    display: flex;
    align-items: center;
    gap: 2px;
    height: 18px;
  }
  .mini-bar {
    width: 3px;
    background: var(--accent);
    border-radius: 2px;
    animation: bar-dance 1.2s ease-in-out infinite;
    opacity: 0.6;
  }
  .mini-bar:nth-child(2) { animation-delay:.15s; }
  .mini-bar:nth-child(3) { animation-delay:.3s; }
  .mini-bar:nth-child(4) { animation-delay:.15s; }
  @keyframes bar-dance {
    0%,100% { height:3px; opacity:0.3; }
    50%      { height:16px; opacity:1; }
  }

  .hdr-right { display:flex; align-items:center; gap:16px; }
  .time {
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    color: var(--accent);
    text-shadow: 0 0 10px rgba(0,212,255,0.4);
  }

  .btn-close {
    width: 26px; height: 26px;
    border-radius: 6px;
    border: 1px solid rgba(255,80,80,0.4);
    background: rgba(255,50,50,0.08);
    color: #ff6666;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
  }
  .btn-close:hover { background: rgba(255,50,50,0.25); border-color: #ff6666; }

  /* â”€â”€ GLASS CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 14px;
    backdrop-filter: blur(20px);
    padding: 14px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
    display: flex;
    flex-direction: column;
  }
  .card:hover { border-color: rgba(0,212,255,0.3); }
  .card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0,212,255,0.4), transparent);
  }

  .card-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--accent);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .card-title::after {
    content: '';
    flex: 1; height: 1px;
    background: linear-gradient(90deg, var(--border), transparent);
  }

  /* Corner brackets */
  .corner { position:absolute; width:10px; height:10px; border-color:var(--accent); border-style:solid; opacity:0.4; }
  .corner.tl { top:5px; left:5px; border-width:1px 0 0 1px; }
  .corner.tr { top:5px; right:5px; border-width:1px 1px 0 0; }
  .corner.bl { bottom:5px; left:5px; border-width:0 0 1px 1px; }
  .corner.br { bottom:5px; right:5px; border-width:0 1px 1px 0; }

  /* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stat-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 10px;
  }
  .stat-label { width: 36px; color: var(--dim); }
  .stat-bar {
    flex: 1; height: 6px;
    background: rgba(0,212,255,0.08);
    border-radius: 3px;
    overflow: hidden;
    border: 1px solid rgba(0,212,255,0.1);
  }
  .stat-fill {
    height: 100%; border-radius: 3px;
    position: relative; overflow: hidden;
    transition: width 0.8s ease;
  }
  .stat-fill::after {
    content: '';
    position: absolute; top:0; left:-100%; width:100%; height:100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2.5s ease-in-out infinite;
  }
  @keyframes shimmer {
    0%   { left: -100%; }
    100% { left:  100%; }
  }
  .stat-val { width:34px; text-align:right; font-size:10px; }
  .good { color: var(--accent2); }
  .warn { color: var(--warn); }
  .crit { color: var(--crit); }

  .sys-info {
    display: flex;
    gap: 12px;
    margin: 8px 0;
    padding: 8px 0;
    border-top: 1px solid var(--border);
    font-size: 9px;
    color: var(--dim);
    flex-wrap: wrap;
  }
  .sys-info span { color: var(--text); }

  /* â”€â”€ PROCESSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .proc-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 7px;
    margin-bottom: 3px;
    background: rgba(0,212,255,0.04);
    border-radius: 5px;
    border: 1px solid rgba(0,212,255,0.07);
    font-size: 9px;
    cursor: default;
    transition: background 0.15s;
  }
  .proc-item:hover { background: rgba(0,212,255,0.1); }
  .proc-name { max-width: 130px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .proc-stats { display:flex; gap:10px; color:var(--dim); }
  .proc-stats .hi { color:var(--accent2); }

  /* â”€â”€ CENTER COLUMN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .center-col { display:flex; flex-direction:column; gap:10px; }

  /* Orb */
  .orb-card {
    flex: 0 0 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .orb-wrap {
    position: relative;
    width: 120px; height: 120px;
    margin: 8px auto 30px;
  }
  .orb {
    position: absolute; inset: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, rgba(0,212,255,0.35), rgba(0,30,80,0.7));
    box-shadow: 0 0 40px rgba(0,212,255,0.3), 0 0 80px rgba(0,212,255,0.15),
                inset 0 0 30px rgba(0,212,255,0.1);
    animation: orb-breathe 3s ease-in-out infinite;
  }
  @keyframes orb-breathe {
    0%,100% { transform:scale(1);   box-shadow: 0 0 40px rgba(0,212,255,0.3), 0 0 80px rgba(0,212,255,0.15); }
    50%     { transform:scale(1.06); box-shadow: 0 0 60px rgba(0,212,255,0.5), 0 0 120px rgba(0,212,255,0.25); }
  }
  .orb-ring {
    position: absolute; border-radius: 50%;
    border: 1px solid rgba(0,212,255,0.2);
    animation: ring-expand 3s ease-out infinite;
  }
  .orb-ring:nth-child(1) { inset:-16px; animation-delay:0s; }
  .orb-ring:nth-child(2) { inset:-32px; animation-delay:1s; }
  .orb-ring:nth-child(3) { inset:-48px; animation-delay:2s; }
  @keyframes ring-expand {
    0%   { opacity:0.6; transform:scale(0.95); }
    100% { opacity:0;   transform:scale(1.1); }
  }
  .orb-state-label {
    position: absolute;
    bottom: -26px; left: 50%;
    transform: translateX(-50%);
    font-family: 'Orbitron', sans-serif;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--accent2);
    white-space: nowrap;
  }

  /* â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .history-card { flex: 1; overflow: hidden; }
  .history-list { overflow-y: auto; flex: 1; }
  .history-list::-webkit-scrollbar { width: 4px; }
  .history-list::-webkit-scrollbar-track { background: rgba(0,212,255,0.05); }
  .history-list::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.3); border-radius: 2px; }

  .cmd-item {
    padding: 7px 10px;
    margin-bottom: 5px;
    background: rgba(0,212,255,0.04);
    border-left: 2px solid rgba(0,212,255,0.25);
    border-radius: 0 7px 7px 0;
    font-size: 10px;
    cursor: default;
    transition: all 0.15s;
  }
  .cmd-item:hover { background: rgba(0,212,255,0.09); border-left-color: var(--accent); }
  .cmd-ts   { color: var(--dim); font-size: 9px; margin-bottom: 2px; }
  .cmd-text { color: var(--accent); }
  .cmd-resp { color: var(--text); font-size: 9px; opacity: 0.65; margin-top: 2px; }

  /* â”€â”€ RIGHT COLUMN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .right-col { display:flex; flex-direction:column; gap:10px; }

  .reminder-item {
    padding: 7px 8px;
    background: rgba(0,255,157,0.05);
    border: 1px solid rgba(0,255,157,0.15);
    border-radius: 7px;
    font-size: 9px;
    margin-bottom: 5px;
    transition: border-color 0.2s;
  }
  .reminder-item:hover { border-color: rgba(0,255,157,0.35); }
  .rem-time { color: var(--accent2); margin-bottom: 2px; }
  .rem-text { color: var(--text); opacity: 0.8; }

  .task-item {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 5px 7px;
    background: rgba(0,212,255,0.04);
    border-radius: 6px;
    font-size: 9px;
    margin-bottom: 4px;
    transition: background 0.15s;
  }
  .task-item:hover { background: rgba(0,212,255,0.1); }
  .task-check {
    width: 13px; height: 13px;
    border: 1px solid var(--accent);
    border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    cursor: pointer;
    font-size: 8px;
    transition: background 0.2s;
  }
  .task-check:hover   { background: rgba(0,212,255,0.2); }
  .task-check.done    { background: var(--accent2); border-color: var(--accent2); color: #000; }
  .task-text.done     { text-decoration: line-through; opacity: 0.35; }
  .task-text          { flex: 1; }

  /* Add task input */
  .add-task-row {
    display: flex;
    gap: 5px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--border);
  }
  .add-task-input {
    flex: 1;
    background: rgba(0,212,255,0.05);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 7px;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    outline: none;
  }
  .add-task-input:focus { border-color: rgba(0,212,255,0.4); }
  .add-btn {
    padding: 4px 8px;
    background: rgba(0,212,255,0.1);
    border: 1px solid rgba(0,212,255,0.3);
    border-radius: 5px;
    color: var(--accent);
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .add-btn:hover { background: rgba(0,212,255,0.2); }

  .empty-msg { color: var(--dim); font-size: 9px; padding: 8px 4px; }

  /* Scrollable inner */
  .scroll-inner { overflow-y: auto; flex: 1; min-height: 0; }
  .scroll-inner::-webkit-scrollbar { width: 3px; }
  .scroll-inner::-webkit-scrollbar-track { background: transparent; }
  .scroll-inner::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.25); border-radius: 2px; }
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <header id="dragbar">
    <div class="logo">JAR<span>V</span>IS</div>
    <div class="hdr-mid">
      <div class="status-dot"></div>
      <span id="state-label">STANDBY</span>
      <div class="mini-bars">
        <div class="mini-bar"></div><div class="mini-bar"></div>
        <div class="mini-bar"></div><div class="mini-bar"></div>
      </div>
    </div>
    <div class="hdr-right">
      <div class="time" id="clock">--:--:--</div>
      <div class="btn-close" onclick="closeWindow()" title="Yopish">âœ•</div>
    </div>
  </header>

  <!-- LEFT: Stats -->
  <div class="card" id="stats-card">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
    <div class="card-title">TIZIM HOLATI</div>

    <div class="stat-row">
      <span class="stat-label">CPU</span>
      <div class="stat-bar"><div class="stat-fill" id="cpu-bar" style="width:0%;background:linear-gradient(90deg,#00d4ff,#0080ff)"></div></div>
      <span class="stat-val" id="cpu-val">â€”</span>
    </div>
    <div class="stat-row">
      <span class="stat-label">RAM</span>
      <div class="stat-bar"><div class="stat-fill" id="ram-bar" style="width:0%;background:linear-gradient(90deg,#00ff9d,#00d4ff)"></div></div>
      <span class="stat-val" id="ram-val">â€”</span>
    </div>
    <div class="stat-row">
      <span class="stat-label">DISK</span>
      <div class="stat-bar"><div class="stat-fill" id="disk-bar" style="width:0%;background:linear-gradient(90deg,#ff6b35,#ff3366)"></div></div>
      <span class="stat-val" id="disk-val">â€”</span>
    </div>
    <div class="stat-row" id="bat-row" style="display:none">
      <span class="stat-label">BAT</span>
      <div class="stat-bar"><div class="stat-fill" id="bat-bar" style="width:0%;background:linear-gradient(90deg,#00ff9d,#00aaff)"></div></div>
      <span class="stat-val" id="bat-val">â€”</span>
    </div>

    <div class="sys-info" id="sys-info">
      <div>OS: <span id="os-val">â€”</span></div>
      <div>HOST: <span id="host-val">â€”</span></div>
      <div>RAM: <span id="ram-detail">â€”</span></div>
    </div>

    <div class="card-title">TOP JARAYONLAR</div>
    <div id="proc-list" class="scroll-inner" style="flex:1"></div>
  </div>

  <!-- CENTER -->
  <div class="center-col">
    <!-- Orb -->
    <div class="card orb-card">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
      <div class="card-title">AI HOLATI</div>
      <div class="orb-wrap">
        <div class="orb-ring"></div>
        <div class="orb-ring"></div>
        <div class="orb-ring"></div>
        <div class="orb" id="orb"></div>
        <div class="orb-state-label" id="orb-label">STANDBY</div>
      </div>
    </div>

    <!-- History -->
    <div class="card history-card">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
      <div class="card-title">BUYRUQLAR TARIXI</div>
      <div class="history-list scroll-inner" id="history-list"></div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right-col">
    <!-- Reminders -->
    <div class="card" style="flex:1">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
      <div class="card-title">ESLATMALAR</div>
      <div class="scroll-inner" id="rem-list"></div>
    </div>

    <!-- Tasks -->
    <div class="card" style="flex:1">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
      <div class="card-title">VAZIFALAR</div>
      <div class="scroll-inner" id="task-list"></div>
      <div class="add-task-row">
        <input class="add-task-input" id="task-input" placeholder="Yangi vazifa..."
               onkeydown="if(event.key==='Enter') addTask()">
        <button class="add-btn" onclick="addTask()">+</button>
      </div>
    </div>
  </div>

</div>

<script>
// â”€â”€ Soat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const n = new Date();
  document.getElementById('clock').textContent =
    String(n.getHours()).padStart(2,'0') + ':' +
    String(n.getMinutes()).padStart(2,'0') + ':' +
    String(n.getSeconds()).padStart(2,'0');
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€ Close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeWindow() {
  if (window.pywebview) window.pywebview.api.close_window();
  else window.close();
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATE_COLORS = {
  idle:       { orb: 'rgba(0,212,255,0.35)',  label: 'STANDBY',      bar: '#00aaff' },
  background: { orb: 'rgba(0,40,80,0.5)',     label: 'FONDA',        bar: '#003355' },
  listening:  { orb: 'rgba(0,255,230,0.4)',   label: 'TINGLAYAPMAN', bar: '#00ffee' },
  processing: { orb: 'rgba(255,160,0,0.4)',   label: "O'YLAMOQDA",   bar: '#ffaa00' },
  speaking:   { orb: 'rgba(0,255,140,0.4)',   label: 'GAPIRMOQDA',   bar: '#00ff88' },
};

function colorForVal(val, warn=60, crit=80) {
  return val >= crit ? 'var(--crit)' : val >= warn ? 'var(--warn)' : 'var(--accent2)';
}

function updateStats(s) {
  if (!s) return;

  const cpu  = s.cpu  || 0;
  const ram  = s.ram  || 0;
  const disk = s.disk || 0;

  document.getElementById('cpu-bar').style.width = cpu + '%';
  document.getElementById('cpu-val').textContent  = cpu + '%';
  document.getElementById('cpu-val').style.color  = colorForVal(cpu, 60, 80);

  document.getElementById('ram-bar').style.width = ram + '%';
  document.getElementById('ram-val').textContent  = ram + '%';
  document.getElementById('ram-val').style.color  = colorForVal(ram, 65, 85);

  document.getElementById('disk-bar').style.width = disk + '%';
  document.getElementById('disk-val').textContent  = disk + '%';
  document.getElementById('disk-val').style.color  = colorForVal(disk, 70, 90);

  if (s.battery != null) {
    document.getElementById('bat-row').style.display = 'flex';
    document.getElementById('bat-bar').style.width = s.battery + '%';
    const batLbl = s.battery + '% ' + (s.plugged ? 'âš¡' : 'ğŸ”‹');
    document.getElementById('bat-val').textContent = batLbl;
    document.getElementById('bat-val').style.color = colorForVal(s.battery, 30, 15);
  }

  document.getElementById('os-val').textContent   = s.os_name  || 'â€”';
  document.getElementById('host-val').textContent = s.hostname || 'â€”';
  const ru = s.ram_used || '?'; const rt = s.ram_total || '?';
  document.getElementById('ram-detail').textContent = ru + '/' + rt + ' GB';

  if (s.processes && s.processes.length) {
    const el = document.getElementById('proc-list');
    el.innerHTML = '';
    s.processes.forEach(p => {
      const div = document.createElement('div');
      div.className = 'proc-item';
      const cpuC = colorForVal(p.cpu, 20, 50);
      const memC = colorForVal(p.mem, 5, 10);
      div.innerHTML = `
        <span class="proc-name" title="${p.name}">${p.name}</span>
        <div class="proc-stats">
          CPU:<span class="hi" style="color:${cpuC}">${p.cpu.toFixed(1)}%</span>
          RAM:<span class="hi" style="color:${memC}">${p.mem.toFixed(1)}%</span>
        </div>`;
      el.appendChild(div);
    });
  }
}

function updateState(state) {
  const cfg = STATE_COLORS[state] || STATE_COLORS.idle;
  document.getElementById('state-label').textContent = cfg.label;
  document.getElementById('orb-label').textContent   = cfg.label;
  const orb = document.getElementById('orb');
  orb.style.background = `radial-gradient(circle at 35% 35%, ${cfg.orb}, rgba(0,20,60,0.8))`;
  orb.style.boxShadow  = `0 0 40px ${cfg.orb}, 0 0 80px rgba(0,212,255,0.1), inset 0 0 30px rgba(0,212,255,0.1)`;
}

function updateHistory(rows) {
  const el = document.getElementById('history-list');
  el.innerHTML = '';
  if (!rows || !rows.length) {
    el.innerHTML = '<div class="empty-msg">Hali buyruqlar tarixi yo\'q</div>';
    return;
  }
  [...rows].reverse().forEach(r => {
    const div = document.createElement('div');
    div.className = 'cmd-item';
    div.innerHTML = `
      <div class="cmd-ts">${r.ts}</div>
      <div class="cmd-text">â–º ${escHtml(r.cmd)}</div>
      <div class="cmd-resp">â—„ ${escHtml((r.resp||'').substring(0,100))}</div>`;
    el.appendChild(div);
  });
}

function updateReminders(rows) {
  const el = document.getElementById('rem-list');
  el.innerHTML = '';
  if (!rows || !rows.length) {
    el.innerHTML = '<div class="empty-msg">Faol eslatmalar yo\'q</div>';
    return;
  }
  rows.forEach(r => {
    const div = document.createElement('div');
    div.className = 'reminder-item';
    div.innerHTML = `<div class="rem-time">â° ${escHtml(r.time_left)}</div>
                     <div class="rem-text">${escHtml(r.msg)}</div>`;
    el.appendChild(div);
  });
}

let _tasks = [];
function updateTasks(tasks) {
  _tasks = tasks || [];
  const el = document.getElementById('task-list');
  el.innerHTML = '';
  if (!_tasks.length) {
    el.innerHTML = '<div class="empty-msg">Vazifalar yo\'q</div>';
    return;
  }
  _tasks.forEach(t => {
    const div = document.createElement('div');
    div.className = 'task-item';
    const done = t.status === 'done' || t.status === 'completed';
    div.innerHTML = `
      <div class="task-check ${done?'done':''}" onclick="toggleTask(${t.id})">${done?'âœ“':''}</div>
      <div class="task-text ${done?'done':''}">${escHtml(t.text||t.title||'')}</div>`;
    el.appendChild(div);
  });
}

async function toggleTask(id) {
  if (window.pywebview) {
    await window.pywebview.api.complete_task(id);
    const tasks = await window.pywebview.api.get_tasks();
    updateTasks(tasks);
  }
}

async function addTask() {
  const inp = document.getElementById('task-input');
  const txt = inp.value.trim();
  if (!txt) return;
  inp.value = '';
  if (window.pywebview) {
    await window.pywebview.api.add_task(txt);
    const tasks = await window.pywebview.api.get_tasks();
    updateTasks(tasks);
  }
}

// â”€â”€ XSS prevention â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Main refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  if (!window.pywebview) return;
  try {
    const [stats, hist, rems, tasks, state] = await Promise.all([
      window.pywebview.api.get_stats(),
      window.pywebview.api.get_history(),
      window.pywebview.api.get_reminders(),
      window.pywebview.api.get_tasks(),
      window.pywebview.api.get_state(),
    ]);
    updateStats(stats);
    updateHistory(hist);
    updateReminders(rems);
    updateTasks(tasks);
    updateState(state);
  } catch(e) {
    console.warn('Refresh error:', e);
  }
}

// Pywebview tayyor bo'lguncha kutish
window.addEventListener('pywebviewready', function() {
  refreshAll();
  setInterval(refreshAll, 3000);
});

// Fallback: pywebview 2s da ham kelmasa, demo mode
setTimeout(function() {
  if (!window.pywebview) {
    updateClock();
    document.getElementById('state-label').textContent = 'OFFLINE';
  }
}, 2000);
</script>
</body>
</html>